<:Window on:click='set({open:false})'/>

<div on:click='event.stopPropagation()'
    class="control-group vis-option-group vis-option-type-select" >

    <div class="dropdown" on:click="onClick(event)">
        <input
            type="search"
            ref:searchInput
            placeholder="{placeholder}"
            bind:value="query"
            on:keypress="keyup(event)"
            on:input="search(query)"
            >

        <div class="btn-wrap">
            <slot name="button">
                <button class="btn btn-small btn-primary" on:click="set({open:true})">
                    <span class="caret"></span>
                </button>
            </slot>
        </div>

        {#if open && matches.length}
        <ul ref:dropdown class="dropdown-results">

            {#each matches as item,i}

            <li class="{i==selectedIndex?'selected':''}" style="{item.style||''}" on:click="select(item)">
                <!-- <i class="fa fa-plus-circle"></i> -->
                {@html item.display || item.title}
            </li>

            {/each}

        </ul>
        {/if}

    </div>
</div>


<script>

    export default {
        data () {
            return {
                query: "",
                placeholder: "",
                filter: 'indexOf',
                selectedItem: undefined,
                selectedIndex: undefined,
                searching: false,
                open: false,
                items: [], // items look like this {id: "foo", title: "", "display": "..."}
            };
        },
        computed: {
            matches({query, items, filter}) {
                if (!filter) return items;
                return items.filter(item => {
                    return (item.search || item.title).toLowerCase().indexOf(query.toLowerCase()) > -1;
                })
            }
        },
        methods: {

            blur() {
                this.refs.searchInput.blur();
            },

            onClick(event) {
                this.set({open:true});
                this.fire('focus', event);
            },

            search(query) {
                this.set({open:true});
                // we're firing the "search" event so that the
                // parent component can update the "items" list
                this.fire('search', {query});
            },

            select(item){
                this.set({
                    selectedItem: item,
                    query: item.title,
                    open: false
                });
                this.fire('select', {item});
            },

            keyup(event){
                if (event.keyCode === 13) {
                    // return
                    const {selectedItem} = this.get();
                    this.select(selectedItem);
                }
                if (event.keyCode == 38 || event.keyCode == 40) {
                    // arrow up/down
                    let {selectedIndex, matches} = this.get();
                    if (isNaN(selectedIndex)) selectedIndex = -1;
                    const len = matches.length||0;
                    if (event.keyCode == 38) {
                        selectedIndex = (selectedIndex-1+len) % len;
                    }
                    if (event.keyCode == 40) {
                        selectedIndex = (selectedIndex+1) % len;
                    }

                    this.set({
                        selectedIndex,
                        selectedItem: matches[selectedIndex]
                    });
                }
            }
        },
        onupdate({changed, current}) {
            if (changed.selectedIndex && this.refs.dropdown) {
                const dd = this.refs.dropdown;
                const i = current.selectedIndex;
                const li_box = dd.children[i].getBoundingClientRect();
                const ul_box = dd.getBoundingClientRect();
                if (li_box.y + li_box.height - ul_box.y > ul_box.height) {
                    // li is out of bottom view
                    dd.scrollBy(0, li_box.y + li_box.height - ul_box.y - ul_box.height+5);
                } else if (li_box.y - ul_box.y < 0) {
                    // li is out of top view
                    dd.scrollBy(0, li_box.y - ul_box.y-5);
                }
            }
        }
    }

 </script>


<style type="text/css">


    .dropdown{
        display: flex;
        flex-wrap: wrap;
    }

    .dropdown-results li.selected {
        background: #cccccc;
    }
    .control-group{
    }

    input{
        margin-bottom: 0px;
  /*      width: 250px;*/
        /*width: calc(100% - 73px);*/
        flex-grow: 4;
    }

    .btn-wrap {
        flex-grow: 1;
    }

    .btn-small {
        max-width: 60px;
        padding: 4px 10px;
        border-radius: 0px 3px 3px 0px !important;
        margin-left: -4px;
        border-left: none;
    }


    .dropdown-results{
        max-height: 150px;
        overflow: auto;
        margin: 0px;
        /*width: 262px;*/
        width: calc(100% - 61px);
        background-color: white;
        border: 1px solid #cccccc;
        margin-top: -1px;
        width: 100%;
    }

    .dropdown-results li {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        padding: 5px 6px;
    }

    .dropdown-results li:hover {
        background-color: #cccccc;
        cursor: pointer;
    }

</style>
