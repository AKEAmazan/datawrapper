<div class="scrollfix-cont" data-offset-top="100" data-offset-bottom="130" style="position:relative;">
    {#if loading}
    loading...
    {/if}
    <div id="iframe-wrapper" style="width:{width}px;height:{height}px; overflow:visible;">
        <iframe title="chart-preview" ref:iframe src="{url}" id="iframe-vis"
            allowfullscreen
            webkitallowfullscreen
            mozallowfullscreen
            oallowfullscreen
            msallowfullscreen></iframe>
    </div>

    <!-- {{ hook('visualize_before_resizer') }}
    {{ hook('render_resize_control') }} -->

    <div id="notifications"></div>
</div>

<style>
#iframe-wrapper {
    margin: 0 auto;
}
</style>

<script>

    let iframe;

    import updateChartDescription from './lib/updateChartDescription';
    import updateChartAttributes from './lib/updateChartAttributes';

    export default {
        computed: {
            url({$id}) {
                return $id ? `/chart/${$id}/preview` : '';
            }
        },
        data() {
            return {
                loading: true,
                width: 500,
                height: 500
            }
        },
        oncreate() {
            iframe = this.refs.iframe;

            // 5. Resize when chart wants to resize itself
            window.addEventListener('message', (e) => {
                var message = e.data;

                if (typeof message['datawrapper-height'] != "undefined") {
                    var h;

                    for (var chartId in message['datawrapper-height']) {
                        h = message['datawrapper-height'][chartId];
                    }

                    this.set({height: h});
            }
            });

            this.store.on('state', ({changed, current, previous}) => {
                if (current.passiveMode) {
                    // no update of chart in iframe when in passiveMode
                    return;
                }
                // watch state changes
                const state = this.store.serialize();
                if (previous && (changed.metadata|| changed.title)) {
                    updateChartDescription({
                        iframe:this.refs.iframe,
                        attrs: state
                    });
                }
                updateChartAttributes({
                    iframe: this.refs.iframe,
                    attrs: state,
                    callback: () => {
                        this.set({loading:false});
                    }
                });
            })
        },
        methods: {
            saved() {
                const win = iframe.contentWindow;
                if (win.__dw && win.__dw.saved) {
                    win.__dw.saved();
                }
            },
            getContext(callback) {
                const win = this.refs.iframe.contentWindow;
                const doc = this.refs.iframe.contentDocument;

                if (!win.__dw || !win.__dw.vis) {
                    return setTimeout(() => {
                        this.getContext(callback);
                    }, 200);
                }
                setTimeout(() => {
                    callback(win, doc);
                }, 1000);
            },
            forceRender() {
                const state = this.store.serialize();
                updateChartAttributes({
                    iframe: this.refs.iframe,
                    attrs:state,
                    forceRender: true,
                    callback: () => {
                        this.set({loading:false});
                    }
                });
            },
            reload() {
                this.refs.iframe.contentWindow.location.reload();
            }
        }
    }

</script>
