<div class="scrollfix-cont" data-offset-top="100" data-offset-bottom="130" style="position:relative;">
    {#if loading}
    loading...
    {/if}
    <div id="iframe-wrapper" class="{resizable?'resizable' :''} {resizing?'resizing' :''}" style="width:{width}px;height:{height}px; overflow:visible;">
        <iframe title="chart-preview" ref:iframe src="{url}" id="iframe-vis"
            allowfullscreen
            webkitallowfullscreen
            mozallowfullscreen
            oallowfullscreen
            msallowfullscreen></iframe>
        {#if resizable}
        <div ref="resizer" on:mousedown="dragStart(event)" class="resizer resizer-both">
            <i class="fa fa-arrows-h"></i>
        </div>
        {/if}

    </div>

    <!-- {{ hook('visualize_before_resizer') }}
    {{ hook('render_resize_control') }} -->

    <div id="notifications"></div>
</div>

<style>
#iframe-wrapper {
    margin: 0 auto;
}
.resizing iframe {
    pointer-events: none;
}
</style>

<script>

    let iframe;
    let preview;

    import updateChartDescription from './lib/updateChartDescription';
    import updateChartAttributes from './lib/updateChartAttributes';

    let startX;
    let startY;
    let startWidth;
    let startHeight;

    function doDrag(event) {
        preview.set({
            width: startWidth + (event.clientX - startX)*2,
            height: startHeight + event.clientY - startY
        });
        event.preventDefault();
        return false;
    }

    function stopDrag() {
        window.document.removeEventListener('mousemove', doDrag);
        window.document.removeEventListener('mouseup', stopDrag);
        preview.set({resizing:false});
        const {width, height} = preview.get();
        preview.fire('resize', {width,height});
    }


    export default {
        computed: {
            url({$id}) {
                return $id ? `/chart/${$id}/preview` : '';
            }
        },
        data() {
            return {
                loading: true,
                resizable: true,
                resizing: false,
                width: 500,
                height: 500
            }
        },
        oncreate() {
            iframe = this.refs.iframe;
            preview = this;

            // 5. Resize when chart wants to resize itself
            window.addEventListener('message', (e) => {
                var message = e.data;

                if (typeof message['datawrapper-height'] != "undefined") {
                    var h;

                    for (var chartId in message['datawrapper-height']) {
                        h = message['datawrapper-height'][chartId];
                    }

                    this.set({height: h});
                }
            });

            const chart = this.store;

            chart.on('state', ({changed, current, previous}) => {
                if (current.passiveMode) {
                    // no update of chart in iframe when in passiveMode
                    return;
                }
                const attrs = chart.serialize();
                if (previous && (changed.metadata|| changed.title)) {
                    updateChartDescription({
                        iframe:this.refs.iframe,
                        attrs
                    });
                }
                updateChartAttributes({
                    iframe: this.refs.iframe,
                    attrs,
                    callback: () => {
                        this.set({loading:false});
                    }
                });
            });

        },
        methods: {
            saved() {
                const win = iframe.contentWindow;
                if (win.__dw && win.__dw.saved) {
                    win.__dw.saved();
                }
            },
            getContext(callback) {
                const win = this.refs.iframe.contentWindow;
                const doc = this.refs.iframe.contentDocument;

                if (!win.__dw || !win.__dw.vis) {
                    return setTimeout(() => {
                        this.getContext(callback);
                    }, 200);
                }
                setTimeout(() => {
                    callback(win, doc);
                }, 1000);
            },
            forceRender() {
                const state = this.store.serialize();
                updateChartAttributes({
                    iframe: this.refs.iframe,
                    attrs:state,
                    forceRender: true,
                    callback: () => {
                        this.set({loading:false});
                    }
                });
            },
            reload() {
                this.refs.iframe.contentWindow.location.reload();
            },
            dragStart(event) {
                startX = event.clientX;
                startY = event.clientY;
                startWidth = this.get().width;
                startHeight = this.get().height;
                this.set({resizing:true});
                window.document.addEventListener('mousemove', doDrag);
                window.document.addEventListener('mouseup', stopDrag);
            }
        }
    }

</script>
