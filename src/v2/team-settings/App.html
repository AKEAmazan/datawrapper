<div class="row" style="">
    <div class="span12 admin">
        <h1 class="title"><b>{ team.name }</b> Â» Team settings</h1>
    </div>
</div>

<div class="row dw-create-visualize chart-editor chart-editor-web" style="margin-top: -20px;">
    <div class="visconfig">
        <div class="span2">
            {#each groups as group}
            <div class="group">{ group.title }</div>

            <ul class="nav nav-stacked nav-tabs">
                {#each group.tabs as tab}
                <li class:active="activeTab === tab.id" on:click="set({activeTab: tab.id})">
                    <a href="#{ tab.id }"><i class="{ tab.icon }"></i> &nbsp; { tab.title } </a>
                </li>
                {/each}
            </ul>
            {/each}
        </div>

        <div class="span10">
            {#if currentTab}
            <div class="vis-options settings-section">
                <h1>{ @html currentTab.h1 }</h1>

                <p style="margin-bottom:10px;">
                    { @html currentTab.p }
                </p>

                <svelte:component
                    this="{ currentTab.app }"
                    bind:team
                    bind:defaultTheme
                    bind:settings
                    bind:loadingUsers
                    bind:users
                    bind:userId
                    bind:visualizations
                    bind:folders
                    bind:themes
                    bind:isAdmin
                    bind:updatingUsers
                    on:change="debounceUpdateTeam()"
                />
            </div>
            {/if}
        </div>
    </div>
</div>

<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';

    import Members from './tabs/Members.html';
    import Settings from './tabs/Settings.html';
    import Slack from './tabs/Slack.html';
    import CustomFields from './tabs/CustomFields.html';
    import PdfToFtp from './tabs/PdfToFtp.html';
    import Visualizations from './tabs/Visualizations.html';
    import DeleteTeam from './tabs/DeleteTeam.html';
    import ProductTable from './tabs/ProductTable.html';

    export default {
        components: {
            Members,
            Settings,
            Slack,
            CustomFields,
            PdfToFtp,
            Visualizations,
            DeleteTeam,
            ProductTable
        },
        data() {
            return {
                allTabs: [
                    {
                        id: 'members',
                        title: 'Members',
                        icon: 'fa fa-users',
                        group: 'Users',
                        order: 1,
                        h1: __('teams / h1'),
                        p: __('teams / p'),
                        app: Members
                    },
                    {
                        id: 'settings',
                        title: 'Settings',
                        icon: 'fa fa-gears',
                        group: 'Users',
                        order: 2,
                        h1: __('teams / defaults / h1'),
                        p: __('teams / defaults / p'),
                        app: Settings
                    },
                    {
                        id: 'slack',
                        title: 'Slack-Notifications',
                        icon: 'fa fa-at',
                        group: 'Advanced',
                        order: 1,
                        h1: __('teams / slack / h1'),
                        p: __('teams / slack / p'),
                        app: Slack
                    },
                    {
                        id: 'customFields',
                        title: 'Custom Fields',
                        icon: 'fa fa-list',
                        group: 'Advanced',
                        order: 2,
                        h1: __('teams / cf / h1'),
                        p: __('teams / cf / p'),
                        app: Settings
                    },
                    {
                        id: 'pdfToFtp',
                        title: 'PDF to FTP',
                        icon: 'fa fa-cloud-upload',
                        group: 'Advanced',
                        order: 3,
                        h1: __('teams / ftp / h1'),
                        p: __('teams / ftp / p'),
                        app: PdfToFtp
                    },
                    {
                        id: 'visTypes',
                        title: 'Visualizations',
                        icon: 'fa fa-ban',
                        group: 'Advanced',
                        order: 4,
                        h1: __('teams / disable / h1'),
                        p: __('teams / disable / p'),
                        app: Visualizations
                    },
                    {
                        id: 'deleteTeam',
                        title: 'Delete team',
                        icon: 'fa fa-times',
                        group: 'Advanced',
                        order: 5,
                        h1: __('teams / delete / h1'),
                        p: __('teams / delete / p'),
                        app: DeleteTeam,
                        ownerOnly: true
                    },
                    {
                        id: 'adminProducts',
                        title: 'Products',
                        icon: 'fa fa-list-alt',
                        group: 'Internal',
                        order: 1,
                        h1: __('teams / products / h1'),
                        p: __('teams / products / p'),
                        app: ProductTable,
                        adminOnly: true
                    }
                ],
                team: {
                    name: ''
                },
                settings: {
                    folders: 'expanded',
                    embed: {
                        preferred_embed: 'responsive',
                        custom_embed: {
                            title: '',
                            text: '',
                            template: ''
                        }
                    },
                    default: {
                        locale: ''
                    },
                    ftp: {
                        enabled: false,
                        server: '',
                        user: '',
                        password: '',
                        directory: '',
                        filename: ''
                    },
                    disableVisualizations: {
                        enabled: false,
                        allowAdmins: false,
                        visualizations: {}
                    }
                },
                loadingUsers: true,
                users: [],
                userId: null,
                visualizations: [],
                deleteTeam: false,
                deleteTeam2: false,
                deleting: false,
                activeTab: 'members'
            };
        },
        computed: {
            role({ users, userId }) {
                if (!users || !users.length || !userId) return false;
                const user = users.find(el => el.id === userId);
                if (user) return user.role;
                else return 'admin';
            },
            currentTab({ activeTab, tabs }) {
                if (!tabs || !activeTab) return null;
                const t = tabs.filter(el => el.id === activeTab);
                return t[0];
            },
            tabs({ allTabs, isAdmin, role }) {
                return allTabs.filter(tab => {
                    if (tab.adminOnly && !isAdmin) return false;
                    if (tab.ownerOnly && (!isAdmin && role !== 'owner')) return false;
                    return true;
                });
            },
            groups({ tabs }) {
                const groups = [];

                function get(groups, groupId) {
                    let g = groups.filter(el => el.title === groupId);
                    if (g.length) return g[0];

                    groups.push({
                        title: groupId,
                        tabs: []
                    });

                    return groups[groups.length - 1];
                }

                tabs.forEach(tab => {
                    get(groups, tab.group).tabs.push(tab);
                });

                return groups;
            }
        },
        helpers: {
            __
        },
        methods: {
            async updateUsers() {
                const res = await this.fetchAPI(`teams/${this.get().team.id}/members`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const json = await res.json();

                this.set({ loadingUsers: false, updatingUsers: false, inviteeEmail: '', users: json.list });
            },
            async debounceUpdateTeam() {
                window.clearTimeout(window.updateTeam);

                window.updateTeam = setTimeout(() => {
                    this.updateTeam();
                }, 200);
            },
            async updateTeam() {
                const { team, defaultTheme, settings } = this.get();

                await this.fetchAPI(`teams/${this.get().team.id}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    body: JSON.stringify({
                        name: team.name,
                        defaultTheme,
                        settings
                    })
                });
            },
            fetchAPI(url, opts) {
                return window.fetch(`//${dw.backend.__api_domain}/v3/${url}`, opts);
            },
            async deleteTeam() {
                this.set({ deleting: true });

                await this.fetchAPI(`teams/${this.get().team.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                window.location = '/';
            }
        },
        onstate({ changed, current, previous }) {
            if (previous && previous.team && previous.team.name) {
                if (changed.team || changed.defaultTheme || changed.settings) {
                    this.debounceUpdateTeam();
                }
            }
        }
    };
</script>

<style lang="less">
    .settings-section {
        padding-top: 10px;
        padding-bottom: 10px;
        margin-top: 10px;
        margin-bottom: 10px;

        border-top: 1px solid #eee;

        &:first-child {
            border-top: none;
        }

        .base-dropdown-content {
            top: 30px !important;
        }
    }

    .group {
        text-transform: uppercase;
        padding: 8px;
        font-weight: bold;
        font-size: 12px;
    }

    li.active a {
        background: #08c;
        color: #fff;
        font-weight: bold;
    }
</style>
