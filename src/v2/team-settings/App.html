<div class="row" style="">
    <div class="span12 admin">
        <h1 class="title" style="margin-bottom:18px">{ __('Settings') } Â» { team.name }</h1>
    </div>
</div>

<div class="row dw-create-visualize chart-editor chart-editor-web" style="margin-top: -20px;">
    <div class="visconfig">
        <div class="span2">
            {#each groups as group}
            <div class="group">{ group.title }</div>

            <ul class="nav nav-stacked nav-tabs">
                {#each group.tabs as tab}
                <li class:active="activeTab === tab.id" on:click="activate(tab.id)">
                    <a href="#{ tab.id }"><i class="{ tab.icon }"></i> &nbsp; { tab.title } </a>
                </li>
                {/each}
            </ul>
            {/each}
            <hr />
            <a href="/account"><i class="fa fa-arrow-left"></i> {__('account / settings / personal')}</a>
        </div>

        <div class="span10">
            {#if currentTab}
            <div class="vis-options settings-section">
                {#if currentTab.h1 }
                <h2>{ @html currentTab.h1 }</h2>
                {/if}

                <svelte:component
                    ref:app
                    this="{ app }"
                    bind:team
                    bind:defaultTheme
                    bind:settings
                    bind:loadingUsers
                    bind:users
                    bind:userId
                    bind:visualizations
                    bind:visualizationArchive
                    bind:folders
                    bind:locales
                    bind:themes
                    bind:isAdmin
                    bind:updatingUsers
                    on:updateUsers="updateUsers()"
                    on:change="debounceUpdateTeam()"
                />
            </div>
            {/if}
        </div>
    </div>
</div>

<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';
    import { loadScript, loadStylesheet } from '../../shared/utils';

    import Members from './tabs/Members.html';
    import Settings from './tabs/Settings.html';
    import CustomFields from './tabs/CustomFields.html';
    import Visualizations from './tabs/Visualizations.html';
    import DeleteTeam from './tabs/DeleteTeam.html';
    import ProductTable from './tabs/ProductTable.html';
    import Loading from './tabs/Loading.html';

    export default {
        components: {
            Members,
            Settings,
            CustomFields,
            Visualizations,
            DeleteTeam,
            ProductTable,
            Loading
        },
        data() {
            return {
                allTabs: [
                    {
                        id: 'settings',
                        title: __('teams / tab / settings'),
                        icon: 'fa fa-gears',
                        group: __('teams / group / users'),
                        order: 10,
                        h1: __('teams / defaults / h1'),
                        app: Settings
                    },
                    {
                        id: 'members',
                        title: __('teams / tab / members'),
                        icon: 'fa fa-users',
                        group: __('teams / group / users'),
                        order: 20,
                        h1: __('teams / h1'),
                        app: Members
                    },
                    {
                        id: 'customFields',
                        title: __('teams / tab / customFields'),
                        icon: 'fa fa-list',
                        group: __('teams / group / advanced'),
                        order: 20,
                        h1: __('teams / cf / h1'),
                        app: CustomFields
                    },
                    {
                        id: 'visTypes',
                        title: __('teams / tab / visTypes'),
                        icon: 'fa fa-ban',
                        group: __('teams / group / advanced'),
                        order: 70,
                        h1: __('teams / disable / h1'),
                        app: Visualizations
                    },
                    {
                        id: 'deleteTeam',
                        title: __('teams / tab / deleteTeam'),
                        icon: 'fa fa-times',
                        group: __('teams / group / advanced'),
                        order: 80,
                        h1: __('teams / delete / h1'),
                        app: DeleteTeam,
                        ownerOnly: true
                    },
                    {
                        id: 'adminProducts',
                        title: __('teams / tab / adminProducts'),
                        icon: 'fa fa-list-alt',
                        group: __('teams / group / internal'),
                        order: 90,
                        h1: __('teams / products / h1'),
                        app: ProductTable,
                        adminOnly: true
                    }
                ],
                pluginTabs: [],
                activeTab: 'settings',
                app: Settings,
                team: {
                    name: ''
                },
                settings: {
                    folders: 'expanded',
                    embed: {
                        preferred_embed: 'responsive',
                        custom_embed: {
                            title: '',
                            text: '',
                            template: ''
                        }
                    },
                    default: {
                        locale: ''
                    },
                    ftp: {
                        enabled: false,
                        server: '',
                        user: '',
                        password: '',
                        directory: '',
                        filename: ''
                    },
                    disableVisualizations: {
                        enabled: false,
                        allowAdmins: false,
                        visualizations: {}
                    }
                },
                users: [],
                userId: null,
                visualizations: [],
                loadingUsers: true
            };
        },
        computed: {
            role({ users, userId }) {
                if (!users || !users.length || !userId) return false;
                const user = users.find(el => el.id === userId);
                if (user) return user.role;
                else return 'admin';
            },
            currentTab({ activeTab, tabs }) {
                if (!tabs || !activeTab) return null;
                const t = tabs.filter(el => el.id === activeTab);
                return t[0];
            },
            tabs({ allTabs, pluginTabs, isAdmin, role }) {
                const tabs = [].concat(allTabs, pluginTabs);

                return tabs.filter(tab => {
                    if (tab.adminOnly && !isAdmin) return false;
                    if (tab.ownerOnly && (!isAdmin && role !== 'owner')) return false;
                    return true;
                });
            },
            groups({ tabs }) {
                const groups = [];

                function get(groups, groupId) {
                    let g = groups.filter(el => el.title === groupId);
                    if (g.length) return g[0];

                    groups.push({
                        title: groupId,
                        tabs: []
                    });

                    return groups[groups.length - 1];
                }

                tabs.forEach(tab => {
                    get(groups, tab.group).tabs.push(tab);
                });

                groups.forEach(group => {
                    group.tabs.sort((a, b) => a.order - b.order);
                });

                return groups;
            }
        },
        helpers: {
            __
        },
        methods: {
            activate(id) {
                const { tabs } = this.get();
                const tab = tabs.filter(el => el.id === id)[0];

                if (tab.src) {
                    if (tab.App) {
                        this.set({
                            activeTab: tab.id,
                            app: tab.App
                        });
                    } else {
                        this.set({
                            activeTab: tab.id,
                            app: Loading
                        });

                        if (tab.css) loadStylesheet(tab.css);

                        loadScript(tab.src, () => {
                            setTimeout(() => {
                                require([tab.id], mod => {
                                    Object.assign(tab, mod);
                                    this.set({ app: tab.App });
                                    if (tab.data) this.refs.app.set(tab.data);
                                });
                            }, 200);
                        });
                    }
                } else {
                    this.set({
                        activeTab: tab.id,
                        app: tab.app
                    });
                }
            },
            async updateUsers() {
                const res = await this.fetchAPI(`teams/${this.get().team.id}/members`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const json = await res.json();

                this.set({ loadingUsers: false, updatingUsers: false, inviteeEmail: '', users: json.list });
            },
            async debounceUpdateTeam() {
                window.clearTimeout(window.updateTeam);

                window.updateTeam = setTimeout(() => {
                    this.updateTeam();
                }, 200);
            },
            async updateTeam() {
                const { team, defaultTheme, settings } = this.get();

                await this.fetchAPI(`teams/${this.get().team.id}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    body: JSON.stringify({
                        name: team.name,
                        defaultTheme,
                        settings
                    })
                });
            },
            fetchAPI(url, opts) {
                return window.fetch(`//${dw.backend.__api_domain}/v3/${url}`, opts);
            }
        },
        onstate({ changed, current, previous }) {
            if (previous && previous.team && previous.team.name) {
                if (changed.team || changed.defaultTheme || changed.settings) {
                    this.debounceUpdateTeam();
                }
            }
        }
    };
</script>

<style lang="less">
    .settings-section {
        padding-top: 10px;
        margin-top: 10px;

        .base-dropdown-content {
            top: 30px !important;
        }
    }

    .group {
        text-transform: uppercase;
        padding: 8px;
        font-weight: bold;
        font-size: 12px;
    }
    li.active a {
        background: #18a1cd;
        border-color: #18a1cd;
        color: #fff;
        font-weight: bold;
    }
    .span2 .nav a i {
        width: 15px;
    }

    .settings-section {
        :global(h2) {
            border-bottom: 1px solid #eee;
            margin-bottom: 1em;
            padding-bottom: 1ex;
        }

        :global(p.help) {
            font-size: 14px;
            color: #777;
            line-height: 1.5;
        }
    }
</style>
