<div class="admin">
    <h1 class="title">Settings</h1>

    <div class="row">
        <div class="span2">
            {#each groups as group}
            <div class="group">{ group.title }</div>

            <ul class="nav nav-stacked nav-tabs">
                {#each group.tabs as tab}
                <li class:active="activeTab === tab">
                    <a href="{ tab.url || `/account/${tab.id}` }" on:click="activateTab(tab, event)"><i class="{ tab.icon }"></i> &nbsp; { tab.title } </a>
                </li>
                {/each}
            </ul>
            {/each}
        </div>
        {#if activeTab}
        <div class="span10 account-page-content tab-{activeTab.id}">
            <svelte:component this="{activeTab.ui}" {...data} />
        </div>
        {/if}
    </div>
</div>
<script>
    /* globals CryptoJS */
    import { __ } from '@datawrapper/shared/l10n';
    import EditProfile from './EditProfile.html';
    import { loadScript, loadStylesheet } from '@datawrapper/shared/fetch';

    const EditProfileTab = {
        title: 'Profile',
        id: 'profile',
        icon: 'fa fa-fw fa-user',
        ui: EditProfile
    };

    export default {
        data() {
            return {
                hash: 'profile',
                activeTab: null,
                groups: [
                    {
                        title: 'Account settings',
                        tabs: [EditProfileTab]
                    },
                    {
                        title: 'Team settings',
                        tabs: [{
                            title: 'Create team',
                            icon: 'fa fa-fw fa-plus',
                            url: '/team/new/setup'
                        }]
                    }
                ]
            };
        },
        methods: {
            activateTab(tab, event=null) {
                if (tab.module) {
                    if (event) event.preventDefault();
                    Promise.all([
                        loadStylesheet(tab.css),
                        loadScript(tab.js)
                    ]).then(() => {
                        require([tab.module], (mod) => {
                            tab.ui = mod.App;
                            tab.module = null;
                            const {groups} = this.get();
                            this.set({
                                groups,
                                activeTab: tab
                            });
                        });
                    });
                    return;
                }
                if (tab.ui) {
                    if (event) event.preventDefault();
                    this.set({activeTab: tab});
                }
            }
        },
        computed: {
            data({ email, userId }) {
                return { email, userId };
            }
        },
        onstate({ changed, current }) {
            if (changed.activeTab && current.activeTab) {
                console.log(current.activeTab);
                window.history.pushState(
                    {id: current.activeTab.id },
                    '',
                    `/account/${current.activeTab.id}`
                );
            }
        },
        oncreate() {
            const path = window.location.pathname.split('/').slice(1);
            const initialTab = path[1] || 'profile';

            dw.backend.__svelteApps.account = this;

            const {groups, teams, pages} = this.get();

            if (pages.length) {
                groups[0].tabs.push.apply(groups[0].tabs, pages);
                this.set({groups});
            }

            if (teams.length) {
                teams.forEach(({Id, Name}) => {
                    groups[1].tabs.push({
                        title: Name,
                        url: `/team/${Id}/settings`,
                        icon: 'fa fa-group fa-fw'
                    })
                });
                // move "create team" to end
                groups[1].tabs.push(groups[1].tabs.shift());
                console.log('x', groups);
                this.set({groups});
            }

            let foundTab = false;
            groups.forEach(group => {
                group.tabs.forEach(tab => {
                    if (tab.id === initialTab) {
                        this.activateTab(tab);
                        foundTab = true;
                    }
                });
            });
            if (!foundTab) {
                this.set({
                    activeTab: EditProfileTab,
                    wasLookingFor: initialTab
                });
            }
        },
        helpers: {
            __
        }
    };
</script>

<style type="text/css" lang="less">
    .settings-section {
        padding-top: 10px;
        margin-top: 10px;

        .base-dropdown-content {
            top: 30px !important;
        }
    }

    .group {
        text-transform: uppercase;
        padding: 8px;
        font-weight: bold;
        font-size: 12px;
    }

    li.active a {
        background: #18a1cd;
        border-color: #18a1cd;
        color: #fff;
        font-weight: bold;
    }

    .span2 .nav a i {
        width: 15px;
    }

    .account-page-content {
        :global(h2) {
            border-bottom: 1px solid #eee;
            margin-bottom: 1em;
            padding-bottom: 1ex;
        }

        :global(p.help) {
            font-size: 16px;
            color: #888;
            line-height: 1.5;
        }
    }

</style>
