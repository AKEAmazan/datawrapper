<div class="admin">
    <h1 class="title">Account Settings</h1>

    <div class="row">
        <div class="span2">
            {#each groups as group}
            <div class="group">{ group.title }</div>

            <ul class="nav nav-stacked nav-tabs">
                {#each group.tabs as tab}
                <li class:active="activeTab === tab">
                    <a href="{ tab.url || `/account/${tab.id}` }" on:click="activateTab(tab, event)"
                        ><i class="{ tab.icon }"></i> &nbsp; { tab.title }
                    </a>
                </li>
                {/each}
            </ul>
            {/each}
        </div>
        {#if activeTab}
        <div class="span10 account-page-content tab-{activeTab.id}">
            <svelte:component this="{activeTab.ui}" {...activeTab.data} />
        </div>
        {/if}
    </div>
</div>
<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';
    import EditProfile from './EditProfile.html';
    import MyTeams from './MyTeams.html';
    import { loadScript, loadStylesheet } from '@datawrapper/shared/fetch';

    const EditProfileTab = {
        title: 'Profile',
        id: 'profile',
        icon: 'im im-user-settings',
        ui: EditProfile
    };

    const MyTeamsTab = {
        title: 'My Teams',
        id: 'teams',
        icon: 'im im-users',
        ui: MyTeams
    };

    export default {
        data() {
            return {
                hash: 'profile',
                activeTab: null,
                activeData: {},
                groups: [
                    {
                        title: 'Personal settings',
                        tabs: [EditProfileTab]
                    }
                ]
            };
        },
        computed: {
            data({ email, user, userId, teams, currentTeam }) {
                return { user, email, userId, teams, currentTeam };
            }
        },
        helpers: {
            __
        },
        methods: {
            activateTab(tab, event = null) {
                if (tab.module) {
                    if (event) event.preventDefault();
                    Promise.all([loadStylesheet(tab.css), loadScript(tab.js)]).then(() => {
                        require([tab.module], mod => {
                            tab.ui = mod.App;
                            tab.module = null;
                            const { groups } = this.get();
                            this.set({
                                groups,
                                activeTab: tab
                            });
                        });
                    });
                    return;
                }
                if (tab.ui) {
                    if (event) event.preventDefault();
                    if (tab.id === 'teams') {
                        const { teams, currentTeam, user } = this.get();
                        tab.data = { teams, currentTeam, user };
                    } else if (tab.id === 'profile') {
                        const { email, userId } = this.get();
                        tab.data = { email, userId };
                    }
                    this.set({ activeTab: tab });
                }
            }
        },
        oncreate() {
            const path = window.location.pathname.split('/').slice(1);
            const initialTab = path[1] || 'profile';

            dw.backend.__svelteApps.account = this;

            const { groups, teams, adminTeams, pages } = this.get();

            if (pages.length) {
                groups[0].tabs.push.apply(groups[0].tabs, pages);
                this.set({ groups });
            }

            if (teams.length) {
                groups[0].tabs.splice(1, 0, MyTeamsTab);
                this.set({ groups });
            }

            if (adminTeams.length) {
                groups.push({
                    title: 'Team settings',
                    tabs: []
                });
                adminTeams.forEach(({ Id, Name }) => {
                    groups[1].tabs.push({
                        title: Name,
                        url: `/team/${Id}/settings`,
                        icon: 'im im-users'
                    });
                });
                this.set({ groups });
            }

            let foundTab = false;
            groups.forEach(group => {
                group.tabs.forEach(tab => {
                    if (tab.id === initialTab) {
                        this.activateTab(tab);
                        foundTab = true;
                    }
                });
            });
            if (!foundTab) {
                this.set({
                    activeTab: EditProfileTab,
                    wasLookingFor: initialTab
                });
            }
        },
        onstate({ changed, current }) {
            if (changed.activeTab && current.activeTab) {
                window.history.pushState({ id: current.activeTab.id }, '', `/account/${current.activeTab.id}`);
            }
        }
    };
</script>

<style type="text/css" lang="less">
    .settings-section {
        padding-top: 10px;
        margin-top: 10px;

        .base-dropdown-content {
            top: 30px !important;
        }
    }

    .group {
        text-transform: uppercase;
        padding: 8px;
        font-weight: bold;
        font-size: 12px;
    }

    li.active a {
        background: #18a1cd;
        border-color: #18a1cd;
        color: #fff;
        font-weight: bold;
    }

    li i.im {
        font-size: 14px;
        position: relative;
        top: 1px;
    }

    .span2 .nav a i {
        width: 15px;
    }

    .account-page-content {
        :global(h2) {
            border-bottom: 1px solid #eee;
            margin-bottom: 1em;
            padding-bottom: 1ex;
        }

        :global(p.help) {
            font-size: 16px;
            color: #888;
            line-height: 1.5;
        }
    }
</style>
