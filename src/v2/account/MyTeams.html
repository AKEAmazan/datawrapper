<!-- <h2>{ __("account / my-teams") }</h2>
 -->
<h2>My Teams</h2>

{#if teams.length}
<p>Here's a list of the teams you're in:</p>

<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Slug*</th>
            <th>Your role</th>
            <th>Team charts</th>
            <th>Settings</th>
            <th>Leave team</th>
        </tr>
    </thead>
    <tbody>
        {#each teams as team}
        <tr class:current="team.Id === currentTeam">
            <td>
                {team.Name} {#if team.Id === currentTeam}
                <i class="fa fa-check-circle"></i>
                {/if}
            </td>
            <td>
                <div class="id">{team.Id}</div>
            </td>
            <td>Member</td>
            <td><a href="/team/{team.Id}">12 charts</a></td>
            <td>
                <a href="/team/{team.Id}/settings" class="btn btn-small">settings</a>
            </td>
            <td>
                <button class="btn btn-small btn-danger"><i class="fa fa-sign-out"></i> leave team</button>
            </td>
        </tr>
        {/each}
    </tbody>
</table>
<p class="mini-help">* The slug is used in internal Datawrapper URLs and can't be changed after team creation.</p>
{:else}
<p>You're not in any teams, yet.</p>
{/if}

<div class="row">
    {#if user.isAdmin}
    <div class="span5">
        <h3>Create a team</h3>
        {#if !createTeam}
        <div class="hed">
            <p>
                Teams can be used to collectively work on charts with other users. You can create as many teams as you want and invite other people to
                join them.
            </p>
            <button on:click="set({createTeam:true})" class="btn btn-large" class:btn-primary="!teams.length">
                <i class="fa fa-plus fa-fw"></i> Create team
            </button>
        </div>
        {:else}
        <p>
            { @html __('team-create / p') }
        </p>

        <FormBlock label="{ __('team-create / name') }" help="{ __('team-create / help') }">
            <input type="text" placeholder="{ __('team-create / untitled') }" bind:value="newTeamName" />
        </FormBlock>

        <button on:click="createTeam(newTeamName)" class="btn btn-primary" disabled="{ !newTeamName.length }">
            {#if awaitCreateTeam} {#await awaitCreateTeam} &nbsp;<i class="fa fa-spinner fa-spin"></i> {:then}<i class="fa fa-check fa-fw"></i
            >{:catch}{/await}{:else}<i class="fa fa-plus fa-fw"></i>{/if} &nbsp; { __('team-create / button') }
        </button>
        <button class="btn" on:click="set({createTeam:false})">{__('Return')}</button>
        {/if}
    </div>
    {/if}
    <div class="span5">
        {#if teams.length > 0}
        <h3>Select active team</h3>
        <p>
            Since you are a member of multiple teams, you have to pick which one you want to be used as <b>active team</b> (indicated with
            <i class="fa fa-check-circle"></i>). Newly created charts will automatically be added to this team, and might also inherit some settings
            from the team.
        </p>
        <FormBlock
            width="350px"
            help="Hint: you can also change the active team at any time using the &nbsp;<i class='fa fa-bars'></i>&nbsp; menu in the top navigation bar."
        >
            <div class="flex">
                <!-- prettier-ignore -->
                <BaseSelect width="250px" bind:value="currentTeam" options="{teamOptions}" />
                {#if awaitActiveTeam} {#await awaitActiveTeam} &nbsp;<i class="fa fa-spinner fa-spin"></i>
                {:then} {:catch}{/await} {/if}
            </div>
        </FormBlock>
        {/if}
    </div>
</div>

<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';
    import Text from '@datawrapper/controls/Text.html';
    import FormBlock from '../shared/FormBlock.html';
    import BaseSelect from '@datawrapper/controls/BaseSelect.html';
    import { putJSON, postJSON } from '@datawrapper/shared/fetch';
    let initialCurrentTeam = null;

    export default {
        components: { FormBlock, BaseSelect, Text },
        data() {
            return {
                teams: [],
                awaitActiveTeam: null,
                awaitCreateTeam: null,
                currentTeam: '',
                createTeam: false,
                newTeamName: '',
                newTeamSlug: ''
            };
        },
        computed: {
            teamOptions({ teams }) {
                return teams
                    .map(({ Id, Name }) => ({
                        value: Id,
                        label: Name
                    }))
                    .concat({
                        value: null,
                        label: __('nav / no-team')
                    });
            }
        },
        helpers: { __ },
        methods: {
            createTeam(name) {
                this.set({
                    awaitCreateTeam: postJSON(`${window.location.protocol}//${dw.backend.__api_domain}/v3/teams`, JSON.stringify({ name })).then(
                        () => {}
                    )
                });
            }
        },
        onstate({ changed, current }) {
            if (changed.currentTeam && current.currentTeam !== undefined) {
                if (!initialCurrentTeam) initialCurrentTeam = current.currentTeam;
                else if (current.currentTeam !== initialCurrentTeam) {
                    initialCurrentTeam = current.currentTeam;
                    this.set({
                        awaitActiveTeam: putJSON(`/team/${current.currentTeam || '@none'}/activate`, {})
                    });
                }
            }
        }
    };
</script>

<style type="text/css">
    .hed {
        margin-bottom: 20px;
    }
    p.mini-help {
        font-size: 12px;
        color: #a8a8a8;
        font-style: italic;
        line-height: 1.2;
    }
    h3 {
        margin-top: 2em;
    }
    .current .name {
        font-weight: bold;
    }
    .id {
        font-family: Roboto Mono;
        color: #888;
    }
</style>
