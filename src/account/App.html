<div class="row">
    <div class="span10 offset1">
        <h1>{ __("Edit profile") }</h1>
        <h2>{ __("Change the e-mail address or password you use to log into Datawrapper.") }</h2>
    </div>
</div>

{#if changePassword }

	<div class="row">
	    <div class="span6 offset3">
	        <div class="form-horizontal edit-account-confirm">
	            <h2>{ __("Change password") }</h2>
	            <p>{ __("For security reasons we ask you to provide your current password. Please make sure you use a strong password.") }</p>
	            <fieldset>
	                <div class="control-group">
	                    <label class="control-label" for="cur-pwd">{ __("Current Password") }</label>
	                    <div class="controls">
	                        <input type="password" class="input-xlarge">
	                        <p class="help-block">{ __("For security reasons, please provide your current password.") }</p>
	                    </div>
	                </div>
	                <div class="control-group">
	                    <label class="control-label" for="pwd">{ __("New Password") }</label>
	                    <div class="controls">
	                        <input type="{ showPasswordInPlaintext ? 'text' : 'password' }" class="input-xlarge">
	                    </div>
	                </div>
	                <div class="control-group">
	                    <label class="control-label" for="pwd2">{ __("(repeat)") }</label>
	                    <div class="controls">
	                        <input type="{ showPasswordInPlaintext ? 'text' : 'password' }" class="input-xlarge">
	                    </div>
	                </div>
	                <div class="control-group">
	                    <div class="controls">
	                        <label class="checkbox">
	                        	<input bind:checked="showPasswordInPlaintext" type="checkbox" />
	                        	{ __("Show password in clear text") }	
	                        </label>
	                    </div>
	                </div>

	                <div>
	                    <button on:click="set({changePassword: false})" class="btn btn-save btn-default btn-back">{ __("Back") }</button>
	                    <button class="btn btn-save btn-primary" type="submit" id="change-password" style="float:right">{ __("Change Password") }</button>
	                </div>
	            </fieldset>
	        </div>
	    </div>
	</div>

{:elseif deleteAccount }

	<div class="row delete-account">
	    <div class="span6 offset3" style="text-align:center">	    	
	        <div class="iconholder">
	            <i class="fa fa-times"></i>
	        </div>

	        <h2 style="margin-bottom:20px">{ __("Are you sure you want to delete your account?") }</h2>


	        <div style="display: flex; justify-content: center; align-items: center;">
	        	<button on:click="set({deleteAccount: false})" class="btn btn-back btn-primary">
	        		<i class="fa fa-chevron-left"></i> &nbsp; { __("No, go back") }
	    		</button>

		        <div style="display:block; margin:0px 10px">{ __("or") }</div>

		        <button on:click="set({deleteAccount: false, deleteAccount2: true})" class="btn btn-default">
		        	<i class="fa fa-times"></i> &nbsp; { __("Yes, delete my account") }
		        </button>
	        </div>	        
	    </div>
	</div>

{:elseif deleteAccount2 }

	<div class="row delete-account">
	    <div class="span6 offset3">
	        <h2 style="margin-bottom:20px">{ __("Account deletion") }</h2>
	        <p>{ __("Think about it one more time. Have you considered all the consequences of deleting your account?") }</p>
	        <ul>
	        	<li>{ __("If you simply want to use Datawrapper for free, you can downgrade your account without deleting it. That way, you keep access to your chart.") }</li>
	            <li>{ __("You cannot login and logout anymore.") }</li>
	            <li>{ __("You cannot edit or remove your charts anymore.") }</li>
	        </ul>
	        <p>{ __("Note that this will only delete your account. Your charts will not be removed. If you want to remove your charts, please do it manually.") }</p>
	        <div class="">
	            <p><b>{ __("Please enter your password to confirm the deletion request:") }</b></p>
	            <div class="control-group">
	                <input type="password" id="confirm-pwd" placeholder="{ __("Password") }" />
	            </div>
	            <p>{@html __("Do you still <b>really</b> want to delete your Datawrapper account?") }</p>
	            <div class="control-group">
	                <button on:click="set({deleteAccount2: false})" class="btn btn-info">
	                	<i class="fa fa-chevron-left"></i>&nbsp;
	                	{ __("No, I changed my mind..") }
	                </button>
	                <button style="float:right" on:click="set({deleteAccount2: false, deleteAccount3: true})" class="btn btn-danger">
	                	<i class="fa fa-times"></i>&nbsp;
	            	    { __("Yes, delete it!") }
	            	</button>
	            </div>
	        </div>
	    </div>
	</div>

{:elseif deleteAccount3 }

	<div class="row delete-account">
	    <div class="span6 offset3" style="text-align:center">	    	
			<h2 style="margin-bottom:20px;text-align:center">{ __("Your account has been deleted.") }</h2>
	        <a href="/" class="btn btn-primary btn-large">{ __("Goodbye!") }</a>
        </div>
    </div>

{:elseif changeEmail}

	<div class="row">
	    <div class="span6 offset3">
	    	<div class="form-horizontal edit-account">
	            <h2>{ __("Change E-Mail") }</h2>
	            <p>{ __("Please note that you'll have to confirm your new e-mail address again after changing it.") }</p>
	            <fieldset>
	                <div class="control-group">
	                    <label class="control-label" for="email">{ __("E-Mail") }:</label>
	                    <div class="controls">
	                        <input disabled="{ !changeEmail }" bind:value="email" type="text" />
	                    </div>
	                </div>
	                
	                <div class="">
	                    <button on:click="set({changeEmail: false})" class="btn btn-default">{ __( "Back") }</button>
	                    <button on:click="changeEmail()" style="float: right;" class="btn btn-save btn-primary">{ __( "Change E-Mail") }</button>
	                </div>
	            </fieldset>
	        </div>	
	    </div>
	</div>

{:else}

	<div class="row edit-account" style="margin-top: 20px;">
	    <div class="span6 offset3">
	    	<div>
				<div>
					{ __("E-Mail") }:
				</div>
				<div>
					<input disabled="{ !changeEmail }" bind:value="email" type="text"/>
				</div>
				<div>
					<button on:click="set({changeEmail: true})" class="btn btn-save btn-default">{ __( "Change E-Mail") }</button>
				</div>    			
	    	</div>

	    	<div>
				<div>
					{ __("Password") }:
				</div>
				<div>
					<input disabled value="abcdefgh" type="password"/>
				</div>
				<div>
					<button on:click="set({changePassword: true})" class="btn btn-save btn-default">{ __("Change Password") }</button>
				</div>    			
	    	</div>

	    	<div style="text-align: center; display: block;">
	        	{ __("or") } <span class="link" on:click="set({deleteAccount: true})" href="#">{ __("delete your account") }</span>.
	        </div>
	    </div>
	</div>

{/if}


<script>
	import {__} from '../shared/l10n';

	export default {
		helpers: {
			__
		},
		methods: {
			changeEmail() {
				var submit = $(e.target),
		        payload = {
		            email: $('#email').val(),
		        };
		        submit.addClass('loading');
		        $.ajax({
		            url: '/api/users/{{ user.id }}',
		            type: 'PUT',
		            dataType: 'json',
		            data: JSON.stringify(payload),
		            success: function(data) {
		                submit.removeClass('loading');
		                if (data.status == 'ok') {
		                    _.each(data.data.messages, function(msg) {
		                        dw.backend.logMessage(msg, $('#edit-account-email .control-group')[0], 'info');
		                    });
		                    _.each(data.data.errors, function(msg) {
		                        dw.backend.logMessage(msg, $('#edit-account-email .control-group')[0], 'warning');
		                    });
		                    $('.profile .reset').prop('disabled', true);
		                } else {
		                    dw.backend.logError(data.message, $('#edit-account-email .control-group')[0]);
		                }
		            }
		         });
			},
			changePassword() {
				var submit = $(e.target),
	                parent = $($('.settings.password .control-group')[0]),
	                curPwd = $.trim($('#cur-pwd').val()),
	                pwd = $.trim($('#pwd').val()),
	                pwd2 = $.trim($('#pwd2').val()),
	                check;

	            dw.backend.clearAlerts()

	            check = dw.backend.checkPassword(curPwd, pwd, pwd2);
	            if (check === true) {
	                // at first we req
	                submit.addClass('loading');

	                $.getJSON('/api/auth/salt', function(res) {
	                    if (res.status == 'ok') {
	                        var salt = res.data.salt
	                            hmac = CryptoJS.HmacSHA256,
	                            payload = {
	                                oldpwhash: hmac(curPwd, salt).toString(),
	                                pwd: CryptoJS.HmacSHA256(pwd, salt).toString()
	                            };

	                        $('#pwd').val('');
	                        $('#pwd2').val('');
	                        $('#cur-pwd').val('');

	                        $.ajax({
	                            url: '/api/users/{{ user.id }}',
	                            type: 'PUT',
	                            data: JSON.stringify(payload),
	                            dataType: 'json',
	                            success: function(data) {
	                                submit.removeClass('loading');
	                                if (data.status == 'ok') {
	                                    _.each(data.data.messages, function(msg) {
	                                        dw.backend.logMessage(msg, $('#edit-account-password .control-group')[0], 'info');
	                                    });
	                                    _.each(data.data.errors, function(msg) {
	                                        dw.backend.logMessage(msg, $('#edit-account-password .control-group')[0], 'warning');
	                                    });
	                                    if (!data.data.errors.length) {
	                                        dw.backend.logMessage('{ __("Congrats! Your password has been changed.") }', $('#edit-account-password .control-group')[0]);
	                                    }
	                                }
	                            }
	                        });
	                    }
	                });
            	}
			},
			deleteAccount() {
				$.getJSON('/api/auth/salt', function(r) {
	                if (r.status == 'ok') {
	                    var cpwd = CryptoJS.HmacSHA256($('#confirm-pwd').val(), r.data.salt).toString();
	                    $.ajax({
	                        url: '/api/users/current?pwd='+cpwd,
	                        type: 'DELETE',
	                        data: JSON.stringify({
	                            pwd: cpwd
	                        }),
	                        dataType: 'json'
	                    }).done(function(res) {
	                        if (res.status == 'ok') {
	                            $('#confirmDeletion .modal-body').remove();
	                            $('#confirmDeletion .modal-footer').remove();
	                            $('#confirmDeletion .post-delete').css({
	                                'text-align': 'center',
	                                'padding': '30px'
	                            });
	                            $('#confirmDeletion .post-delete').addClass('modal-body');
	                            $('#confirmDeletion .post-delete').show();
	                        } else {
	                            dw.backend.logError(res.message, $('#confirm-pwd').parent());
	                        }
	                    }).fail(function(res) {
	                        dw.backend.logError('could not delete user: ' + JSON.stringify(res), $('#confirm-pwd').parent());
	                    });
	                } else {
	                    dw.backend.logError('could not load salt', $('#confirm-pwd').parent());
	                }
	            });
			}
		},
		data() {
			return {
				changePassword: false,
				changeEmail: false,
				deleteAccount: false,
				showPasswordInPlaintext: false
			}
		}
	}
</script>	


<style type="text/css" lang="less">
	.edit-account {  	
		#input-email,
		#input-password {
	  		margin-bottom: 0px;
		}
	}

	.edit-account > .span6 > div {
		display: flex;
		justify-content: space-around;
		font-size: 18px;

		div::first-child {
			text-align: right;
		}

		div::last-child {
			text-align: right;
		}
	}

	.delete-account {
		padding-top: 10px;

	    h2 {
	    	margin: 0px 0px 20px 0px;
	    }

	    .iconholder {
			color: #c71e1d;
			text-align: center;
			display: block;
			font-size: 48px;
			height: 55px;
		}
	}	

	.link {
	    color: #1d81a2;
	    font-weight: bold;
	    cursor: pointer;
	}
</style>