<div class="chart-editor">
    <div class="row">
        <div class="span4">
            <h3 class="first">{{ __("Make sure the data looks right") }}</h3>

            <p>{{ __("Please make sure that Datawrapper interprets your data correctly. In the table number columns should be shown in blue, dates in green and text in black.") }}</p>

            <Checkbox label="{{ __("First row as label") }}" bind:value="firstRowIsHeader" />
            <Checkbox label="transpose" bind:value="transpose" />
        </div>
        <div class="span8">
            <div class="input-append">
                <input type="text" on:keypress="keyPress(event)" placeholder="{{__('Search data table')}}" bind:value="search" ref:search />
                <div class="btn-group">
                  <button class="btn" on:click="nextResult(-1)">
                    <i class="fa fa-chevron-up"></i></button>
                  <button class="btn" on:click="nextResult(+1)">
                    <i class="fa fa-chevron-down"></i></button>
                </div>
            </div>

            <div class="results">
            {{#if searchResults.length > 0}}
                {{searchIndexSafe+1}} of {{searchResults.length}} cells matching
            {{elseif search}}
                No matches found
            {{/if}}
            </div>

            <Handsontable
                bind:data="chartData"
                bind:transpose
                bind:firstRowIsHeader
                bind:search
                bind:searchResults
                bind:searchIndex />

            <div class="buttons below-table pull-right">
                <button class="btn transpose" on:click="toggleTranspose()">{{__("Transpose dataset")}}</button>
                <button class="btn computed-columns"><i class="fa fa-calculator"></i> {{__("computed columns / add-btn")}}...</button>

                <button class="btn disabled" id="reset-data-changes"><i class="fa fa-undo"></i> {{__("Revert changes")}}...</button>
            </div>
        </div>
    </div>
</div>

<script>
    import Handsontable from './Handsontable.html';
    import Checkbox from '../controls/Checkbox.html';

    export default {
        components: { Handsontable, Checkbox },
        computed: {
            searchIndexSafe (searchIndex, searchResults) {
                if (searchIndex<0) searchIndex+=searchResults.length;
                searchIndex = searchIndex % searchResults.length;
                return searchIndex;
            }
        },
        oncreate() {
            console.log('chart', this.store.get('dw_chart'));
            window.addEventListener('keypress', (event) => {
                console.log('event',event);
                if (event.ctrlKey && event.key == 'f') {
                    console.log('search!');
                    event.preventDefault();
                    if (this.refs.search != window.document.activeElement) {
                        this.refs.search.focus();
                    } else {
                        this.nextResult(+1);
                    }
                }
            });
        },
        methods: {
            nextResult (diff) {
                let {searchIndex, searchResults} = this.get();
                searchIndex += diff;
                if (searchIndex<0) searchIndex+=searchResults.length;
                searchIndex = searchIndex % searchResults.length;
                this.set({searchIndex});
            },
            keyPress (event) {
                if (event.key == 'F3') this.nextResult(event.shiftKey ? -1 : 1);
            },
            toggleTranspose() {
                this.set({transpose: !this.get('transpose')});
            }
        },
        data() {
            return {
                search: '',
                chartData: '',
                transpose: false,
                firstRowIsHeader: true,
                searchIndex: 0,
                searchResults: []
            };
        }
    };
</script>

<style lang="less">
    .results {
        color: gray;
        display: inline-block;
        vertical-align: text-bottom;
        margin-left: 1ex;
    }
    .below-table {
        margin-top: 20px;
    }
</style>
