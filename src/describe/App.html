<div class="chart-editor">
    <div class="row">
        <div class="span4">
            <div class="sidebar">
                {{#if customColumn}}

                <ComputedColumnEditor
                    on:updateTable="refs.hot.update()"
                    bind:column="customColumn"
                    bind:columns />

                {{elseif columnFormat}}

                <CustomColumnFormat
                    on:updateTable="refs.hot.update()"
                    bind:column="columnFormat"
                    bind:columns />

                {{else}}
                <h3 class="first">{{ __("Make sure the data looks right") }}</h3>

                <p>{{ __("Please make sure that Datawrapper interprets your data correctly. In the table number columns should be shown in blue, dates in green and text in black.") }}</p>

                <Checkbox
                    label="{{ __("First row as label") }}"
                    bind:value="firstRowIsHeader" />

                [TODO: hook]
                <hr>

                <div class="btn-group">
                    <a class="btn submit" href="upload"><i class="icon-chevron-left"></i> Zur√ºck</a>
                    <a href="visualize" class="submit btn btn-primary" id="describe-proceed">Weiter <i class="icon-chevron-right icon-white"></i></a>
                </div>
                {{/if}}
            </div>
        </div>
        <div class="span8">

            <div class="help">
                Click on table header to edit column properties. <img src="/static/img/arrow.svg" />
            </div>
            <div class="search-box pull-right">
                <i class="fa fa-search"></i>
                <div class="input-append">
                    <input type="text" on:keypress="keyPress(event)" placeholder="{{__('Search data table')}}" bind:value="search" ref:search class="{{searchResults.length > 0?'with-results':''}}" />
                    {{#if searchResults.length > 0}}
                    <div class="btn-group">
                      <button class="btn" on:click="nextResult(-1)">
                        <i class="fa fa-chevron-up"></i></button>
                      <button class="btn" on:click="nextResult(+1)">
                        <i class="fa fa-chevron-down"></i></button>
                    </div>
                    {{/if}}
                </div>

                {{#if search}}
                <div class="results">
                    {{#if searchResults.length > 0}}
                        {{searchIndexSafe+1}}
                        {{__("describe / search / of") }}
                        {{searchResults.length}}
                        {{__("describe / search / results") }}
                    {{elseif search}}
                        {{ __("describe / search / no-matches") }}
                    {{/if}}
                </div>
                {{/if}}
            </div>

            <Handsontable ref:hot
                bind:data="chartData"
                bind:transpose
                bind:firstRowIsHeader
                bind:activeColumn
                bind:search
                bind:searchResults
                bind:searchIndex />

            <div class="buttons below-table pull-right">
                <button class="btn transpose" on:click="toggleTranspose()"><img src="/static/css/chart-editor/transpose.png"> {{__("describe / transpose-long")}}</button>

                <button on:click="addComputedColumn()" class="btn computed-columns"><i class="fa fa-calculator"></i> {{__("computed columns / add-btn")}}...</button>

                <button on:click="revertChanges()" class="btn {{has_changes?'':'disabled'}}" id="reset-data-changes"><i class="fa fa-undo"></i> {{__("Revert changes")}}...</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* global chart */
    import Handsontable from './Handsontable.html';
    import ComputedColumnEditor from './ComputedColumnEditor.html';
    import CustomColumnFormat from './CustomColumnFormat.html';
    import Checkbox from '../controls/Checkbox.html';

    import {arrayToObject} from '../shared/utils.js';

    export default {
        components: { Handsontable, Checkbox, ComputedColumnEditor, CustomColumnFormat },
        computed: {
            searchIndexSafe (searchIndex, searchResults) {
                if (searchIndex<0) searchIndex+=searchResults.length;
                searchIndex = searchIndex % searchResults.length;
                return searchIndex;
            },
            customColumn (activeColumn) {
                return activeColumn && activeColumn.isComputed ? activeColumn : false;
            },
            columnFormat (activeColumn) {
                return activeColumn && !activeColumn.isComputed ? activeColumn : false;
            },
            columns (activeColumn) {
                if (!activeColumn) return [];
                try {
                    const ds = chart.dataset();
                    return ds.columns().filter(col => !col.isComputed);
                } catch(e) {
                    return [];
                }
            }
        },
        oncreate() {
            window.addEventListener('keypress', (event) => {
                if (event.ctrlKey && event.key == 'f') {
                    event.preventDefault();
                    if (this.refs.search != window.document.activeElement) {
                        this.refs.search.focus();
                    } else {
                        this.nextResult(+1);
                    }
                }
            });
            const sync = (svelte_key, metadata_key) => {
                this.observe(svelte_key, (svelte_value) => {
                    this.store.get('dw_chart').set(`metadata.${metadata_key}`, svelte_value);
                });
            };
            sync('transpose', 'data.transpose');
            sync('firstRowIsHeader', 'data.horizontal-header');


        },
        methods: {
            nextResult (diff) {
                let {searchIndex, searchResults} = this.get();
                searchIndex += diff;
                if (searchIndex<0) searchIndex+=searchResults.length;
                searchIndex = searchIndex % searchResults.length;
                this.set({searchIndex});
            },
            keyPress (event) {
                if (event.key == 'F3' || event.key == 'Enter')
                    this.nextResult(event.shiftKey ? -1 : 1);
            },
            toggleTranspose() {
                this.set({transpose: !this.get('transpose')});
            },
            revertChanges() {
                const chart = this.store.get('dw_chart');
                chart.set('metadata.data.changes', []);
                chart.saveSoon();
                this.refs.hot.update();
            },
            cmFocus () {
                setTimeout(() => {
                    this.refs.hot.get('hot').render();
                }, 100);
            },
            addComputedColumn() {
                const chart = this.store.get('dw_chart');
                const ds = chart.dataset();
                const computed = arrayToObject(chart.get('metadata.describe.computed-columns', {}));
                // find new id
                let i = 1;
                while (ds.hasColumn(`Column ${i}`)) {
                    i++;
                }
                const id = `Column ${i}`;
                console.log(id);
                computed[id] = '';
                chart.set('metadata.describe.computed-columns', computed);
                chart.saveSoon();
                const ds2 = chart.dataset(true);
                this.refs.hot.update();
                this.set({ activeColumn: ds2.column(id) });
            }
        },
        data() {
            return {
                search: '',
                chartData: '',
                transpose: false,
                firstRowIsHeader: true,
                searchIndex: 0,
                activeColumn: false,
                customColumn: false,
                columnFormat: false,
                searchResults: []
            };
        }
    };
</script>

<style lang="less">
    .help {
        display: inline-block;
        font-style: italic;
        color: #aaa;
    }
    .below-table {
        margin-top: 20px;
    }
    .span8 {
        padding-top: 1em;
    }
    .btn.transpose img {
        width: 12px;
        vertical-align: baseline;
    }
    .search-box {
        position: relative;
        .results {
            color: gray;
            display: inline-block;
            vertical-align: text-bottom;
            margin-left: 1ex;
        }
        input {
            padding-left: 26px;
            border-radius: 4px;
            width: 24ex;
            &.with-results {
                width: 18ex;
                border-bottom-right-radius: 0px;
                border-top-right-radius: 0px;
            }
        }
        .fa-search {
            position: absolute;
            left: 8px;
            top: 6px;
            color: #ddd;
            font-size: 16px;
            z-index: 4;
        }
        .btn-group .btn:first-child {
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
        }
    }
</style>
