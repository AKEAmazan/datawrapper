
<div id="data-preview" ref:hot />

<script>
    // import '/static/plugins/simple-maps/vendor/hot/handsontable.full.js?foo';
    import HOT from 'Handsontable';

    export default {
        oncreate() {
            const {table} = this.get();

            const cells = (row, col, prop) => {
                const {readonly, dataset} = this.get();
                return {
                    readOnly: readonly || dataset.column(col).isComputed && row === 0,
                    renderer: getCellRenderer(dataset, HOT, {})
                };
            };

            const hot = new HOT(this.refs.hot, {
                data: [],
                rowHeaders: true,
                colHeaders: true,
                fixedRowsTop: 1,
                filters: true,
                dropdownMenu: true,
                startRows: 60,
                startCols: 8,
                fillHandle: false,
                stretchH: 'all',
                manualColumnMove: true,
                comments: true,
                contextMenu: true,
                columnSorting: true,
                sortIndicator: true,
                cells
            });
            window.HT = hot;

            HOT.hooks.add('afterSetDataAtCell', (a,b,c,d) => {
                console.log('afterSetDataAtCell', a,b,c,d);
                // this.set({table});
            });

            this.observe('dataset', (dataset) => {
                if (!dataset || !dataset.list) return;
                var header = [];
                var data = [[]];
                dataset.eachColumn((c) => data[0].push(c.title()));
                dataset.eachRow((r,i) => {
                    var row = [];
                    dataset.eachColumn((col) => {
                        row.push(col.val(r));
                    });
                    data.push(row);
                });
                hot.loadData(data);
                hot.updateSettings({cells});
                // comments
                const comments = hot.getPlugin('comments');
                comments.setCommentAtCell(2,2, 'Original: foobar');
                comments.updateCommentMeta(2,2, {readOnly:true});
                hot.render();
            });

        },
        data() {
            return {
                dataset: null,
                table: [
                    {id: 1, name: 'Ted Right', address: ''},
                    {id: 2, name: 'Frank Honest', address: ''},
                    {id: 3, name: 'Joan Well', address: ''},
                    {id: 4, name: 'Gail Polite', address: ''},
                    {id: 5, name: 'Michael Fair', address: ''}
                ]
            };
        }
    };

    function getCellRenderer(dataset, Handsontable, metadata) {
        const colTypeIcons = {
            date: 'fa fa-clock-o'
        };
        function HtmlCellRender(instance, TD, row, col, prop, value, cellProperties) {
            var escaped = dw.utils.purifyHtml(Handsontable.helper.stringify(value));
            TD.innerHTML = escaped; //this is faster than innerHTML. See: https://github.com/warpech/jquery-handsontable/wiki/JavaScript-&-DOM-performance-tips
        }
        return function(instance, td, row, col, prop, value, cellProperties) {
            var column = dataset.column(col);
            if (row > 0) {
                var formatter = chart.columnFormatter(column);
                value = formatter(column.val(row - 1), true);
            }
            if (parseInt(value, 10) < 0) { //if row contains negative number
                td.classList.add('negative');
            }
            td.classList.add(column.type()+'Type');

            if (row === 0) {
                td.classList.add('firstRow');
                if (colTypeIcons[column.type()]) {
                    value = '<i class="'+colTypeIcons[column.type()]+'"></i> ' + value;
                }
            } else {
                td.classList.add(row % 2 ? 'oddRow' : 'evenRow');
            }

            // if (metadata.columnFormat.get(column.name()).ignore) {
            //     td.classList.add('ignored');
            // }
            // if(selectedColumns.indexOf(col) > -1) {
            //     td.classList.add('area'); //add blue area background if this cell is in selected column
            // }
            if (row > 0 && !column.type(true).isValid(column.val(row-1))) {
                td.classList.add('parsingError');
            }
            if (cellProperties.readOnly) td.classList.add('readOnly');

            if (chart.dataCellChanged(col, row)) {
                td.classList.add('changed');
            }
            HtmlCellRender.apply(this, arguments);
        };
    }

</script>

<style lang="less">
:global(#data-preview) {
    width: 770px;
    height: 500px;
    max-height: 500px;
    overflow: auto;

    tr td, tr th {
        font-family: 'Roboto Mono', fixed;
        font-size:12px;
    }

    tr td {
        padding: 3px 6px;

        &.textType {
            color: #000000;
        }

        &.dateType {
            color: #39A832;
            text-align: center;
        }

        &.numberType {
            color: #297EA8;
            text-align: right;
        }

        &.parsingError {
            background: #fee;
            color: #c00;
        }

        &.readOnly {
            // background: mix(#F1F0E3, white);
            // &.evenRow { background: #F1F0E3; }
            &.firstRow {
                background: #EAEAEA;
                border-right-color: #aaa;
                color: #777;
            }
        }


        &.changed {
            position: relative;

            &:before {
                content: ' ';
                width: 0;
                height: 0;
                border-top: 7px solid orange;
                border-right: 7px solid transparent;
                display: block;
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    }

    tbody tr:first-child td {
        background: #f3f3f3;
        font-weight: bold;
        border-bottom: 1px solid #999;
    }
    .htCommentCell:after {
        border-left: 8px solid transparent;
        border-top: 8px solid orange;
    }
}
</style>
