<div>
    <h3 class="first">Edit column "{{column.name()}}"</h3>

    <div class="form-horizontal">

        <Checkbox
            label="{{ __("Hide column from visualization") }}"
            bind:value="columnFormat.ignore" />

        <Select
            label="Column format"
            options="{{colTypes}}"
            bind:value="columnFormat.type"
            width="180px"
            />
    </div>
</div>

<script>
    import Checkbox from '../controls/Checkbox.html';
    import Select from '../controls/Select.html';
    import _throttle from 'underscore-es/throttle';
    import {arrayToObject} from '../shared/utils.js';

    export default {
        components: { Checkbox, Select },
        methods: {

        },
        oncreate() {
            const updateTable = _throttle(() => this.fire('updateTable'), 500, {leading: false});

            console.log('CustomColumnFormat create');

            const {column} = this.get();
            const chart = this.store.get('dw_chart');
            const columnFormats = arrayToObject(chart.get('metadata.data.column-format', {}));

            let columnFormat = columnFormats[column.name()];
            if (!columnFormat || columnFormat == 'auto' || columnFormat.length !== undefined) {
                // no valid column format
                columnFormat = {
                    type: 'auto',
                    ignore: false
                };
            }

            this.set({columnFormat});

            this.set({colTypes: [
                { value:'auto', label: 'auto ('+column.type()+')' },
                { value:'text', label: 'Text' },
                { value:'number', label: 'Number' },
                { value:'date', label: 'Date' },
            ]});

            this.observe('columnFormat', (colFormat) => {
                const t0 = (new Date()).getTime();
                const chrt = this.store.get('dw_chart');
                const columnFormats = arrayToObject(chrt.get('metadata.data.column-format', {}));
                let oldFormat = columnFormats[column.name()];
                if (JSON.stringify(oldFormat) != JSON.stringify(colFormat)) {
                    console.log('new format!');
                    columnFormats[column.name()] = colFormat;
                    chrt.set('metadata.data.column-format', columnFormats);
                    if (chrt.saveSoon) chrt.saveSoon();
                    updateTable();
                    const t1 = (new Date()).getTime()-t0;
                    console.log(t1,'ms');
                }
            });
        },
        data() {
            return {
                columnFormat: {
                    type: 'auto',
                    ignore: false,
                },
                colTypes: []
            }
        }
    };
</script>


<style lang="less">
:global(.vis-option-type-select) {
    .control-label {
        width: 100px;
    }
    .controls {
        margin-left: 120px;
    }
}
</style>
