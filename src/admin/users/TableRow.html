<tr class="user role-{user.role}">
    <td class="id out">
        <a href="?currentUser={user.id}" on:click="navigate(event, user.id)">
            {user.id}
        </a>
    </td>

    {#if !edit}
    <td>{user.name || '–'}</td>
    <td>{user.email}</td>
    <td>
        <i class="icon-{role.icon}" title="Editor"></i>
        {__(role.name, 'admin-users')}
    </td>
    {:else}
    <td>
        <input type="text" bind:value="updates.name" data-test="input-name" />
    </td>
    <td class="email">
        <input type="email" bind:value="updates.email" data-test="input-email" />
    </td>
    <td>
        <select name="role" bind:value="updates.role">
            {#each roleOptions as role}
            <option value="{role.slug}" selected="{user.role === role.slug}">
                {__(role.name, 'admin-users')}
            </option>
            {/each}
        </select>
    </td>
    {/if}

    <td data-test="display-teams">{@html teamsFormatted}</td>
    <td data-test="display-createdat">{createdAtFormatted}</td>
    <td class="center">
        <a href="/admin/chart/by/{user.id}">{user.chartCount}</a>
    </td>

    {#if !edit}
    <td class="actions">
        <button class="action" on:click="edit()" data-test="action-edit">
            <i class="icon-pencil" title="{__('edit', 'admin-users')}"></i>
        </button>
        <button class="action">
            <i class="icon-envelope" title="{__('reset the password and send a mail', 'admin-users')}"></i>
        </button>
    </td>
    {:else}
    <td class="actions">
        <button class="action" on:click="save()" data-test="action-save">
            <i class="icon-ok" title="{__('save', 'admin-users')}"></i>
        </button>
        <button class="action" on:click="set({ edit: false })" data-test="action-close">
            <i class="icon-remove" title="{__('cancel', 'admin-users')}"></i>
        </button>
    </td>
    {/if}
</tr>

<style>
    input,
    select {
        max-width: 150px;
    }

    .actions {
        white-space: nowrap;
        width: 30px;
    }

    .action {
        border: 0;
        margin: 0 20px 0 0;
        padding: 0;
        background: transparent;
        display: inline;
    }

    .role-admin {
        color: #c00;
    }

    .role-pending {
        background: #f3f3d7;
    }
</style>

<script>
    import { __ } from '../../shared/l10n';
    import moment from 'moment';

    const linkToTeam = ({ name, id }) => `<a href="/admin/organizations/${id}">${name}</a>`;

    export default {
        data() {
            return {
                user: {},
                updates: {},
                edit: false,
                roleOptions: [
                    { slug: 'admin', name: 'Administrator', icon: 'fire' },
                    { slug: 'editor', name: 'Editor', icon: 'user' },
                    { slug: 'pending', name: 'Pending', icon: 'user' },
                    { slug: 'sysadmin', name: 'System Administrator', icon: 'user' },
                    { slug: 'graphic-editor', name: 'Editor', icon: 'user' }
                ]
            };
        },

        computed: {
            role: ({ user, roleOptions }) => roleOptions.find(({ slug }) => slug === user.role),
            createdAtFormatted: ({ user }) => moment(user.createdAt).format('lll'),
            teamsFormatted: ({ user }) => user.teams.map(linkToTeam).join(', ') || '–'
        },

        helpers: {
            __
        },

        methods: {
            edit() {
                this.set({
                    edit: true,
                    updates: Object.assign({}, this.get().user) // clone original user data
                });
            },

            save() {
                const { user, updates } = this.get();
                const changes = Object.keys(user).reduce((diff, key) => {
                    if (updates[key] !== user[key]) {
                        diff[key] = updates[key];
                    }
                    return diff;
                }, {});

                this.set({ edit: false, user: updates });
                this.fire('save', { userId: user.id, changes });
            },

            navigate(event, userId) {
                event.preventDefault();
                this.fire('navigate', userId);
            }
        }
    };
</script>
