<div>
    {#if userDetails}
    <UserDetails user="{userDetails}" on:close="closeDetails()"></UserDetails>
    {:else}
    <div>
        <table class="table users">
            <TableHeader headerItems="{columnHeaders}" on:sort="sort(event)"></TableHeader>

            <tbody class="users">
                {#each list as user}
                <TableRow {user} on:navigate="showDetails(event)" on:save="saveUser(event)"></TableRow>
                {/each}
            </tbody>
        </table>
        {#if paginationItems.length > 0}
        <div class="pull-right">
            <Pagination pages="{paginationItems}" on:navigate="gotoPage(event)" {currentPageNum}></Pagination>
        </div>
        {/if}
    </div>
    {/if}
</div>

<script>
    import { parse, stringify } from 'query-string';
    import { __ } from '../../shared/l10n';
    import { getJSON, patchJSON } from '../../shared/utils';
    import UserDetails from './UserDetails.html';
    import TableHeader from './TableHeader.html';
    import TableRow from './TableRow.html';
    import Pagination from './Pagination.html';

    const BASE_URL = '//api.datawrapper.local:18080/v3/users';

    export default {
        components: {
            UserDetails,
            TableHeader,
            TableRow,
            Pagination
        },

        data() {
            return {
                list: [],
                orderBy: 'id',
                loader: null,
                offset: 0,
                limit: 10,
                total: 0,
                currentUser: null,
                userDetails: null,
                columnHeaders: [
                    { name: '#', orderBy: 'id' },
                    { name: __('Name', 'admin-users'), orderBy: 'name' },
                    { name: __('Sign-in', 'admin-users'), orderBy: 'email' },
                    { name: __('Status', 'admin-users') },
                    { name: __('Teams', 'admin-users') },
                    { name: __('Created at', 'admin-users'), orderBy: 'createdAt' },
                    { name: __('Charts', 'admin-users') },
                    { name: __('Actions', 'admin-users') }
                ]
            };
        },

        computed: {
            currentPageNum: ({ limit, offset }) => Math.ceil(offset / limit),
            paginationItems: ({ total, limit, offset }) =>
                Array.from({ length: Math.ceil(total / limit) }, (v, i) => ({
                    state: { limit, offset: i * limit }
                }))
        },

        helpers: {
            __
        },

        methods: {
            sort(orderBy) {
                this.set({ orderBy, offset: 0 });
                const state = { orderBy };
                window.history.replaceState(state, '', `?${stringify(state)}`);
                this.loadUserList();
            },

            gotoPage({ offset, limit }) {
                this.set({ offset, limit });
                const { orderBy } = this.get();
                const state = { offset, limit, orderBy };
                window.history.replaceState(state, '', `?${stringify(state)}`);
                this.loadUserList();
            },

            showDetails(currentUser) {
                this.set({ currentUser });
                window.history.replaceState({ currentUser }, '', `?currentUser=${currentUser}`);
                this.loadUser();
            },

            closeDetails() {
                const state = { currentUser: null, userDetails: null };
                this.set(state);
                window.history.replaceState(state, '', '?');
            },

            loadUserList() {
                const { offset, limit, orderBy } = this.get();
                const loader = getJSON(`${BASE_URL}?${stringify({ offset, limit, orderBy })}`, data => {
                    if (data && data.list) {
                        const { total, list } = data;
                        this.set({ list, total });
                    }
                });
                this.set({ loader });
            },

            loadUser() {
                const { currentUser } = this.get();
                if (currentUser) {
                    getJSON(`${BASE_URL}/${currentUser}`, data => {
                        if (data) this.set({ userDetails: data });
                    });
                }
            },

            saveUser({ userId, changes }) {
                const requestBody = JSON.stringify(changes, (key, value) => {
                    if (value === null) {
                        return undefined; // do not pass `null` (`null` means value not set)
                    } else if (value === '') {
                        return null; // pass `null` to set value to empty string
                    } else {
                        return value;
                    }
                });

                patchJSON(`${BASE_URL}/${userId}`, requestBody);
            }
        },

        oncreate() {
            const { offset, orderBy, currentUser } = parse(window.location.search);
            this.set({ offset, orderBy, currentUser });
            this.loadUserList();
            this.loadUser();
        }
    };
</script>
