<section>
    <h4>{ user.email }</h4>

    <form class="form-horizontal" on:submit="save()">
        <div class="control-group">
            <label class="control-label">#</label>
            <div class="controls">
                <span class="value">{user.id}</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="name">{__('Name', 'admin-users')}</label>
            <div class="controls">
                <input type="text" id="name" bind:value="updates.name" />
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="email">{__('Email', 'admin-users')}</label>
            <div class="controls">
                <input type="text" id="email" bind:value="updates.email" />
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="role">{__('Status', 'admin-users')}</label>
            <div class="controls">
                <select name="role" bind:value="updates.role">
                    {#each roleOptions as role}
                    <option value="{role.slug}" selected="{user.role === role.slug}">
                        {__(role.name, 'admin-users')}
                    </option>
                    {/each}
                </select>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">{__('Charts', 'admin-users')}</label>
            <div class="controls">
                <a class="value" href="/admin/chart/by/{ user.id }">
                    {user.chartCount}
                </a>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">{__('Created at', 'admin-users')}</label>
            <div class="controls">
                <span class="value">{createdAtFormatted}</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" for="passwordToken">{__('Password', 'admin-users')}</label>
            <div class="controls">
                <input type="text" id="passwordToken" bind:value="resetPasswordToken" placeholder="optional: one-time password" />
                <button type="button" on:click="resetPassword()" class="btn btn-default">
                    {__('reset password', 'admin-users')}
                </button>
                {#if user.resetPasswordToken}
                <div class="token-url">
                    <code>{passwordResetLink}</code>
                </div>
                {/if}
            </div>
        </div>

        <div class="control-group">
            <div class="controls controls-submit">
                <button type="submit" class="btn btn-primary" data-test="save">
                    {__('save', 'admin-users')}
                </button>
                <button type="button" class="btn btn-default" on:click="close()" data-test="close">
                    {__('cancel', 'admin-users')}
                </button>
            </div>
        </div>
    </form>
</section>

<style>
    .control-group .control-label {
        text-align: right;
    }

    .value {
        padding: 0.35em;
        display: inline-block;
    }

    .control-group {
        margin-bottom: 0.35em;
    }

    .token-url {
        margin: 0.35em 0 0.7em 0;
    }

    .controls-submit button {
        margin: 0.35em 0.35em 0 0;
    }
</style>

<script>
    import { __ } from '../../shared/l10n';
    import moment from 'moment';

    const { protocol, host } = window.location;

    export default {
        data: () => ({
            resetPasswordToken: '',
            user: {},
            updates: {}
        }),

        computed: {
            role: ({ user, roleOptions }) => roleOptions.find(({ slug }) => slug === user.role),
            createdAtFormatted: ({ user }) => moment(user.createdAt).format(__('YYYY-MM-DD, hh:mm a', 'admin-users')),
            passwordResetLink: ({ user }) => `${protocol}//${host}/account/reset-password/${encodeURI(user.resetPasswordToken)}`
        },

        helpers: {
            __
        },

        methods: {
            close() {
                this.fire('close');
            },

            save(event) {
                const { user, updates } = this.get();
                const changes = Object.keys(user).reduce((diff, key) => {
                    if (updates[key] !== user[key]) {
                        diff[key] = updates[key];
                    }
                    return diff;
                }, {});

                this.set({ edit: false, user: updates });
                this.fire('save', { userId: user.id, changes });
            },

            resetPassword() {
                const { user, resetPasswordToken } = this.get();
                this.fire('resetPassword', {
                    email: user.email,
                    token: resetPasswordToken
                });
            }
        },

        oncreate() {
            // clone original user & token data:
            const { user } = this.get();
            this.set({
                updates: Object.assign({}, user)
            });
        }
    };
</script>
