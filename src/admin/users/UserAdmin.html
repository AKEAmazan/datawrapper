<div>
    {#if userDetails}
    <UserAdminDetails user="{userDetails}" />
    {/if}

    <table class="table users">
        <UserAdminTableHeader headerItems="{columnHeaders}" on:sort="sort(event)"></UserAdminTableHeader>
        {#if loader} {#await loader}
        <p>Loading</p>
        {:then answer}
        <tbody class="users">
            {#each list as user}
            <UserAdminTableRow {user} on:navigate="showDetails(event)"></UserAdminTableRow>
            {/each}
        </tbody>
        {:catch error}
        <p>An error occured while loading user list.</p>
        {/await} {/if}
    </table>

    {#if paginationItems.length > 0}
    <div class="pull-right">
        <UserAdminPagination pages="{paginationItems}" on:navigate="gotoPage(event)" {currentPageNum}></UserAdminPagination>
    </div>
    {/if}
</div>

<script>
    import { parse, stringify } from 'query-string';
    import { __ } from '../../shared/l10n';
    import { getJSON } from '../../shared/utils';
    import UserAdminDetails from './UserAdminDetails.html';
    import UserAdminTableHeader from './UserAdminTableHeader.html';
    import UserAdminTableRow from './UserAdminTableRow.html';
    import UserAdminPagination from './UserAdminPagination.html';

    const BASE_URL = '//api.datawrapper.local:18080/v3/users';

    export default {
        components: {
            UserAdminDetails,
            UserAdminTableHeader,
            UserAdminTableRow,
            UserAdminPagination
        },

        data() {
            return {
                list: [],
                orderBy: 'id',
                loader: null,
                offset: 0,
                limit: 10,
                total: 0,
                columnHeaders: [
                    { name: '#', orderBy: 'id' },
                    { name: __('Name', 'admin-users'), orderBy: 'name' },
                    { name: __('Sign-in', 'admin-users'), orderBy: 'email' },
                    { name: __('Status', 'admin-users') },
                    { name: __('Created at', 'admin-users'), orderBy: 'createdAt' },
                    { name: __('Charts', 'admin-users') },
                    { name: __('Actions', 'admin-users') }
                ]
            };
        },

        computed: {
            currentPageNum: ({ limit, offset }) => Math.ceil(offset / limit),
            paginationItems: ({ total, limit, offset }) =>
                Array.from({ length: Math.ceil(total / limit) }, (v, i) => ({
                    state: { limit, offset: i * limit }
                }))
        },

        helpers: {
            __
        },

        methods: {
            sort(orderBy) {
                this.set({ orderBy, offset: 0 });
                const state = { orderBy };
                window.history.replaceState(state, '', `/admin/users?${stringify(state)}`);
                this.loadUserList();
            },

            gotoPage({ offset, limit }) {
                this.set({ offset, limit });
                const { orderBy } = this.get();
                const state = { offset, limit, orderBy };
                window.history.replaceState(state, '', `/admin/users?${stringify(state)}`);
                this.loadUserList();
            },

            showDetails(currentUser) {
                this.set({ currentUser });
                window.history.replaceState({ currentUser }, '', `/admin/users?currentUser=${currentUser}`);
                this.loadUserDetails();
            },

            loadUserList() {
                const { offset, limit, orderBy } = this.get();
                const loader = getJSON(`${BASE_URL}?${stringify({ offset, limit, orderBy })}`, data => {
                    if (data && data.list) {
                        const { total, list } = data;
                        this.set({ list, total });
                    }
                });
                this.set({ loader });
            },

            loadUserDetails() {
                const { currentUser } = this.get();
                if (currentUser) {
                    getJSON(`${BASE_URL}/${currentUser}`, data => {
                        if (data) this.set({ userDetails: data });
                    });
                }
            }
        },

        oncreate() {
            const urlQuery = parse(window.location.search);
            this.set(urlQuery);
            this.loadUserList();
            this.loadUserDetails();
        }
    };
</script>
